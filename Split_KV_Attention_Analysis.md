# Split-KVæ³¨æ„åŠ›æœºåˆ¶æ·±åº¦åˆ†æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±åº¦è§£æäº†`split_kv_attention`å‡½æ•°çš„æ¥æºã€åŸç†ã€å®ç°å’Œå½¢è±¡åŒ–è§£é‡Šï¼Œå¸®åŠ©ç†è§£è¿™ç§æ³¨æ„åŠ›æœºåˆ¶ä¼˜åŒ–æ–¹æ³•åŠå…¶éç¡®å®šæ€§ç‰¹å¾ã€‚

## ğŸ”¬ æ¥æºä¸èƒŒæ™¯

### ç†è®ºåŸºç¡€
- **Transformeræ¶æ„ (2017)**: Vaswani et al. æå‡ºæ³¨æ„åŠ›æœºåˆ¶
- **å¤šå¤´æ³¨æ„åŠ›**: å°†æ³¨æ„åŠ›åˆ†è§£ä¸ºå¤šä¸ªå¹¶è¡Œå¤´
- **è®¡ç®—ä¼˜åŒ–éœ€æ±‚**: å¤§è§„æ¨¡æ¨¡å‹éœ€è¦æ›´é«˜æ•ˆçš„æ³¨æ„åŠ›è®¡ç®—

### ç›¸å…³ç ”ç©¶
- **Multi-Query Attention (MQA)**: å¤šä¸ªæŸ¥è¯¢å…±äº«ä¸€ä¸ªé”®å€¼å¯¹
- **Grouped Query Attention (GQA)**: LLaMA 2ä¸­ä½¿ç”¨çš„åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›
- **Flash Attention**: é€šè¿‡åˆ†å—è®¡ç®—ä¼˜åŒ–å†…å­˜ä½¿ç”¨
- **Split-KV**: å°†é”®å€¼å¯¹åˆ†å‰²å¤„ç†ï¼Œå‡å°‘è®¡ç®—å¤æ‚åº¦

### å®ç°èƒŒæ™¯
- **å†…å­˜ä¼˜åŒ–**: å‡å°‘GPUå†…å­˜å ç”¨
- **å¹¶è¡Œè®¡ç®—**: æé«˜è®¡ç®—æ•ˆç‡
- **é•¿åºåˆ—å¤„ç†**: å¤„ç†è¶…é•¿è¾“å…¥åºåˆ—
- **æ¨ç†åŠ é€Ÿ**: ä¼˜åŒ–æ¨¡å‹æ¨ç†é€Ÿåº¦

## ğŸ—ï¸ å®ç°åŸç†

### æ ¸å¿ƒæ€æƒ³
Split-KVæ³¨æ„åŠ›é€šè¿‡å°†é”®(Key)å’Œå€¼(Value)åºåˆ—åˆ†å‰²æˆå¤šä¸ªå—ï¼Œåˆ†åˆ«è®¡ç®—æ³¨æ„åŠ›ï¼Œç„¶ååˆå¹¶ç»“æœï¼Œä»è€Œå‡å°‘å•æ¬¡è®¡ç®—çš„å†…å­˜å ç”¨å’Œè®¡ç®—å¤æ‚åº¦ã€‚

### å®ç°æ­¥éª¤
1. **é‡å¡‘ä¸ºå¤šå¤´æ ¼å¼**: å°†è¾“å…¥é‡å¡‘ä¸ºå¤šå¤´æ³¨æ„åŠ›æ ¼å¼
2. **åˆ†å‰²KVåºåˆ—**: å°†é”®å€¼å¯¹æŒ‰åºåˆ—ç»´åº¦åˆ†å‰²
3. **åˆ†åˆ«è®¡ç®—æ³¨æ„åŠ›**: å¯¹æ¯ä¸ªåˆ†å‰²å—è®¡ç®—æ³¨æ„åŠ›
4. **åˆå¹¶ç»“æœ**: å°†å„åˆ†å‰²å—çš„ç»“æœåˆå¹¶

### ä»£ç å®ç°
```python
def split_kv_attention(self, q, k, v, num_heads=8, num_splits=4):
    # 1. é‡å¡‘ä¸ºå¤šå¤´æ ¼å¼
    q = q.view(batch_size, seq_len, num_heads, head_dim).transpose(1, 2)
    k = k.view(batch_size, seq_len, num_heads, head_dim).transpose(1, 2)
    v = v.view(batch_size, seq_len, num_heads, head_dim).transpose(1, 2)
    
    # 2. åˆ†å‰²KVåºåˆ—
    split_size = seq_len // num_splits
    outputs = []
    
    for i in range(num_splits):
        start_idx = i * split_size
        end_idx = start_idx + split_size if i < num_splits - 1 else seq_len
        
        k_split = k[:, :, start_idx:end_idx, :]
        v_split = v[:, :, start_idx:end_idx, :]
        
        # 3. è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°
        scores = torch.matmul(q, k_split.transpose(-2, -1)) / np.sqrt(head_dim)
        attn_weights = F.softmax(scores, dim=-1)
        
        # 4. åº”ç”¨æ³¨æ„åŠ›æƒé‡
        out_split = torch.matmul(attn_weights, v_split)
        outputs.append(out_split)
    
    # 5. åˆå¹¶ç»“æœï¼ˆè¿™é‡Œå¼•å…¥éç¡®å®šæ€§ï¼‰
    out = outputs[0]
    for i in range(1, len(outputs)):
        out = out + outputs[i]
    
    return out
```

## âš ï¸ éç¡®å®šæ€§åˆ†æ

### éç¡®å®šæ€§æ¥æº
1. **å¹¶è¡Œå½’çº¦é¡ºåº**: å¤šä¸ªåˆ†å‰²ç»“æœçš„åˆå¹¶é¡ºåºå¯èƒ½ä¸åŒ
2. **æµ®ç‚¹æ•°ç´¯ç§¯è¯¯å·®**: å¤šæ¬¡åŠ æ³•è¿ç®—çš„ç´¯ç§¯è¯¯å·®
3. **å¹¶è¡Œè®¡ç®—ç«äº‰**: å¹¶è¡Œæ‰§è¡Œæ—¶çš„ç«äº‰æ¡ä»¶
4. **å†…å­˜è®¿é—®æ¨¡å¼**: ä¸åŒçš„å†…å­˜è®¿é—®é¡ºåº

### è¯¯å·®ä¼ æ’­æœºåˆ¶
- æ¯ä¸ªåˆ†å‰²äº§ç”Ÿå¾®å°è¯¯å·®
- åˆå¹¶è¿‡ç¨‹ä¸­çš„è¯¯å·®ç´¯ç§¯
- æµ®ç‚¹æ•°éç»“åˆæ€§æ”¾å¤§è¯¯å·®
- æœ€ç»ˆç»“æœå‡ºç°å¯è§‚æµ‹å·®å¼‚

### å½±å“ç¨‹åº¦
- å·®å¼‚é€šå¸¸åœ¨ 1e-8 åˆ° 1e-6 ä¹‹é—´
- å¯¹æ¨¡å‹æ€§èƒ½å½±å“è¾ƒå°
- ä½†åœ¨ç¡®å®šæ€§è¦æ±‚é«˜çš„åœºæ™¯ä¸­éœ€è¦å…³æ³¨

## ğŸ­ å½¢è±¡åŒ–è§£é‡Š

### å­¦æ ¡è€ƒè¯•æ¯”å–»
æƒ³è±¡ä¸€ä¸ªå¤§å‹è€ƒè¯•ï¼Œæœ‰1000ä¸ªå­¦ç”Ÿï¼ˆåºåˆ—é•¿åº¦ï¼‰éœ€è¦ç­”é¢˜ï¼š

**æ ‡å‡†æ³¨æ„åŠ› (ä¼ ç»Ÿæ–¹æ³•)**:
- æ‰€æœ‰å­¦ç”ŸåŒæ—¶çœ‹åˆ°æ‰€æœ‰é¢˜ç›®
- æ¯ä¸ªå­¦ç”Ÿéƒ½è¦å¤„ç†1000é“é¢˜
- è®¡ç®—é‡å¤§ï¼Œéœ€è¦å¤§é‡èµ„æº

**Split-KVæ³¨æ„åŠ› (åˆ†å‰²æ–¹æ³•)**:
- å°†1000é“é¢˜åˆ†æˆ4ç»„ï¼Œæ¯ç»„250é“
- å­¦ç”Ÿå…ˆåšç¬¬1ç»„é¢˜ï¼Œå†åšç¬¬2ç»„é¢˜...
- æœ€åå°†å„ç»„ç»“æœåˆå¹¶
- æ¯æ¬¡å¤„ç†çš„é¢˜ç›®æ›´å°‘ï¼Œæ•ˆç‡æ›´é«˜

**éç¡®å®šæ€§é—®é¢˜**:
- ä¸åŒå­¦ç”Ÿå®Œæˆå„ç»„çš„é¡ºåºå¯èƒ½ä¸åŒ
- åˆå¹¶ç»“æœæ—¶çš„å°æ•°ç‚¹è¯¯å·®
- æœ€ç»ˆç­”æ¡ˆå¯èƒ½æœ‰å¾®å°å·®å¼‚

### å·¥å‚ç”Ÿäº§æ¯”å–»
æƒ³è±¡ä¸€ä¸ªæ±½è½¦å·¥å‚ï¼Œéœ€è¦ç»„è£…1000ä¸ªé›¶ä»¶ï¼š

**æ ‡å‡†æ–¹æ³•**:
- ä¸€ä¸ªå·¥äººå¤„ç†æ‰€æœ‰1000ä¸ªé›¶ä»¶
- å·¥ä½œé‡å¤§ï¼Œå®¹æ˜“å‡ºé”™

**Split-KVæ–¹æ³•**:
- å°†é›¶ä»¶åˆ†æˆ4ç»„ï¼Œæ¯ç»„250ä¸ª
- 4ä¸ªå·¥äººå¹¶è¡Œå¤„ç†ä¸åŒç»„
- æœ€åå°†å„ç»„ç»“æœç»„è£…
- æ•ˆç‡æ›´é«˜ï¼Œä½†å¯èƒ½æœ‰å¾®å°å·®å¼‚

## ğŸ“Š æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | ç¡®å®šæ€§ | å†…å­˜ä½¿ç”¨ | å¤æ‚åº¦ | å¹¶è¡Œåº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|----------|--------|--------|----------|
| æ ‡å‡†å¤šå¤´æ³¨æ„åŠ› | å®Œå…¨ç¡®å®š | é«˜ | O(nÂ²) | ä¸­ç­‰ | å°è§„æ¨¡æ¨¡å‹ |
| Split-KVæ³¨æ„åŠ› | éç¡®å®š | ä¸­ç­‰ | O(nÂ²/k) | é«˜ | å¤§è§„æ¨¡æ¨¡å‹ |
| åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ› | ç¡®å®š | ä½ | O(nÂ²/g) | é«˜ | LLaMA 2ç­‰æ¨¡å‹ |
| å¤šæŸ¥è¯¢æ³¨æ„åŠ› | ç¡®å®š | æœ€ä½ | O(nÂ²) | ä¸­ç­‰ | æ¨ç†ä¼˜åŒ– |

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### è®¡ç®—å¤æ‚åº¦
- **æ ‡å‡†æ³¨æ„åŠ›**: O(nÂ²) - éœ€è¦è®¡ç®—æ‰€æœ‰ä½ç½®å¯¹çš„æ³¨æ„åŠ›
- **Split-KVæ³¨æ„åŠ›**: O(nÂ²/k) - å…¶ä¸­kæ˜¯åˆ†å‰²æ•°ï¼Œå‡å°‘äº†å•æ¬¡è®¡ç®—é‡

### å†…å­˜ä½¿ç”¨
- **æ ‡å‡†æ³¨æ„åŠ›**: éœ€è¦å­˜å‚¨å®Œæ•´çš„æ³¨æ„åŠ›çŸ©é˜µ
- **Split-KVæ³¨æ„åŠ›**: åªéœ€è¦å­˜å‚¨åˆ†å‰²åçš„æ³¨æ„åŠ›çŸ©é˜µ

### å¹¶è¡Œåº¦
- **æ ‡å‡†æ³¨æ„åŠ›**: ä¸­ç­‰å¹¶è¡Œåº¦ï¼Œä¸»è¦åœ¨å¤šå¤´ç»´åº¦å¹¶è¡Œ
- **Split-KVæ³¨æ„åŠ›**: é«˜å¹¶è¡Œåº¦ï¼Œå¯ä»¥åœ¨åˆ†å‰²ç»´åº¦å¹¶è¡Œ

## ğŸ¯ åº”ç”¨åœºæ™¯

### é€‚ç”¨åœºæ™¯
- **å¤§è§„æ¨¡æ¨¡å‹**: å¤„ç†è¶…é•¿åºåˆ—
- **å†…å­˜å—é™ç¯å¢ƒ**: GPUå†…å­˜ä¸è¶³æ—¶
- **æ¨ç†ä¼˜åŒ–**: éœ€è¦å¿«é€Ÿæ¨ç†çš„åœºæ™¯
- **å¹¶è¡Œè®¡ç®—**: å……åˆ†åˆ©ç”¨å¤šæ ¸GPU

### ä¸é€‚ç”¨åœºæ™¯
- **ç¡®å®šæ€§è¦æ±‚é«˜**: éœ€è¦å®Œå…¨ç¡®å®šç»“æœçš„åœºæ™¯
- **å°è§„æ¨¡æ¨¡å‹**: åˆ†å‰²å¼€é”€å¯èƒ½å¤§äºæ”¶ç›Š
- **å®æ—¶åº”ç”¨**: å¯¹å»¶è¿Ÿè¦æ±‚æé«˜çš„åœºæ™¯

## ğŸ”§ ä¼˜åŒ–å»ºè®®

### å‡å°‘éç¡®å®šæ€§
1. **å›ºå®šåˆå¹¶é¡ºåº**: ä½¿ç”¨å›ºå®šçš„å½’çº¦é¡ºåº
2. **é«˜ç²¾åº¦è®¡ç®—**: ä½¿ç”¨æ›´é«˜ç²¾åº¦çš„æµ®ç‚¹æ•°
3. **ç¡®å®šæ€§ç®—æ³•**: ä½¿ç”¨ç¡®å®šæ€§å½’çº¦ç®—æ³•

### æ€§èƒ½ä¼˜åŒ–
1. **åŠ¨æ€åˆ†å‰²**: æ ¹æ®åºåˆ—é•¿åº¦åŠ¨æ€è°ƒæ•´åˆ†å‰²æ•°
2. **å†…å­˜ç®¡ç†**: ä¼˜åŒ–å†…å­˜åˆ†é…å’Œé‡Šæ”¾
3. **å¹¶è¡Œç­–ç•¥**: ä¼˜åŒ–å¹¶è¡Œè®¡ç®—ç­–ç•¥

## ğŸ“š ç›¸å…³è®ºæ–‡

è™½ç„¶Split-KVæ³¨æ„åŠ›æ²¡æœ‰æ˜ç¡®çš„åŸå§‹è®ºæ–‡ï¼Œä½†å®ƒåŸºäºä»¥ä¸‹ç ”ç©¶ï¼š

1. **Attention Is All You Need** (Vaswani et al., 2017) - Transformeræ¶æ„
2. **GQA: Training Generalized Multi-Query Transformer Models** - åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›
3. **FlashAttention: Fast and Memory-Efficient Exact Attention** - åˆ†å—æ³¨æ„åŠ›è®¡ç®—
4. **PaLM: Scaling Language Modeling with Pathways** - å¤§è§„æ¨¡æ¨¡å‹ä¼˜åŒ–

## ğŸ’¡ æ€»ç»“

Split-KVæ³¨æ„åŠ›æ˜¯ä¸€ç§æœ‰æ•ˆçš„æ³¨æ„åŠ›æœºåˆ¶ä¼˜åŒ–æ–¹æ³•ï¼Œé€šè¿‡åˆ†å‰²é”®å€¼å¯¹æ¥å‡å°‘è®¡ç®—å¤æ‚åº¦å’Œå†…å­˜ä½¿ç”¨ã€‚è™½ç„¶å®ƒå¼•å…¥äº†éç¡®å®šæ€§ï¼Œä½†è¿™ç§éç¡®å®šæ€§é€šå¸¸å¾ˆå°ï¼Œå¯¹æ¨¡å‹æ€§èƒ½å½±å“æœ‰é™ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦æ ¹æ®å…·ä½“éœ€æ±‚æƒè¡¡ç¡®å®šæ€§å’Œæ•ˆç‡ã€‚

### å…³é”®è¦ç‚¹
1. **æ•ˆç‡æå‡**: æ˜¾è‘—å‡å°‘å†…å­˜ä½¿ç”¨å’Œè®¡ç®—å¤æ‚åº¦
2. **éç¡®å®šæ€§**: å¼•å…¥å¾®å°çš„æ•°å€¼å·®å¼‚
3. **é€‚ç”¨æ€§**: ç‰¹åˆ«é€‚åˆå¤§è§„æ¨¡æ¨¡å‹å’Œé•¿åºåˆ—å¤„ç†
4. **æƒè¡¡**: éœ€è¦åœ¨æ•ˆç‡å’Œç¡®å®šæ€§ä¹‹é—´åšå‡ºæƒè¡¡

è¿™ç§æœºåˆ¶ä½“ç°äº†æ·±åº¦å­¦ä¹ ä¼˜åŒ–ä¸­çš„ä¸€ä¸ªé‡è¦è¶‹åŠ¿ï¼šé€šè¿‡å¼•å…¥å¯æ§çš„éç¡®å®šæ€§æ¥æ¢å–è®¡ç®—æ•ˆç‡çš„æå‡ã€‚
